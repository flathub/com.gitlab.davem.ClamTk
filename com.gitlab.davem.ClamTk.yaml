app-id: com.gitlab.davem.ClamTk
runtime: org.freedesktop.Platform
runtime-version: '22.08'
sdk: org.freedesktop.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.rust-stable
command: clamtk
rename-icon: clamtk
copy-icon: true
finish-args:
  - '--filesystem=host'
  - '--share=ipc'
  - '--share=network'
  - '--socket=x11'
  - '--socket=wayland'
modules:
  # Based on https://github.com/flathub/io.github.Hexchat.Plugin.Perl
  - name: perl
    no-autogen: true
    config-opts:
      - '-des'
      - '-Duseshrplib'
    build-options:
      cflags: '-fPIC'
      ldflags: '-fpic'
    sources:
      - type: archive
        url: https://www.cpan.org/src/5.0/perl-5.34.0.tar.gz
        sha256: 551efc818b968b05216024fb0b727ef2ad4c100f8cb6b43fab615fa78ae5be9a
      - type: shell
        commands:
          - 'ln -s configure{.gnu,}'
    post-install:
      - 'chmod -R u+w /app/lib/perl5'
    cleanup:
      - '/bin/corelist'
      - '/bin/cpan'
      - '/bin/enc2xs'
      - '/bin/encguess'
      - '/bin/h2ph'
      - '/bin/h2xs'
      - '/bin/instmodsh'
      - '/bin/json_pp'
      - '/bin/libnetcfg'
      - '/bin/perlbug'
      - '/bin/perldoc'
      - '/bin/perlivp'
      - '/bin/perlthanks'
      - '/bin/piconv'
      - '/bin/pl2pm'
      - '/bin/pod*'
      - '/bin/prove'
      - '/bin/ptar*'
      - '/bin/shasum'
      - '/bin/splain'
      - '/bin/xsubpp'
      - '/bin/zipdetails'
      - '/include'
      - '/man'
      - '*.pod'

  - name: perl-libs
    buildsystem: simple
    build-commands:
      - 'perl-libs/install.sh'
    post-install:
      - 'chmod -Rf u+w /app/lib/perl5/site_perl'
    sources:
      - generated-sources.json
    cleanup:
      - '/bin'
      - '/man'

  - name: json-c
    buildsystem: cmake-ninja
    config-opts:
      - '-DCMAKE_BUILD_TYPE=RelWithDebInfo'
    sources:
      - type: archive
        url: https://github.com/json-c/json-c/archive/json-c-0.16-20220414.tar.gz
        sha256: 3ecaeedffd99a60b1262819f9e60d7d983844073abc74e495cb822b251904185
    cleanup:
      - '/include'
      - '/lib/cmake'
      - '/lib/pkgconfig'
      - '*.a'

  - name: clamav
    buildsystem: cmake-ninja
    build-options:
      append-path: '/usr/lib/sdk/rust-stable/bin'
    config-opts:
      - '-DCMAKE_BUILD_TYPE=RelWithDebInfo'
      - '-DENABLE_MILTER=OFF'
      - '-DENABLE_CLAMONACC=OFF'
      - '-DENABLE_TESTS=OFF'
      - '-DENABLE_SYSTEMD=OFF'
      - '-DENABLE_MAN_PAGES=OFF'
      - '-DDATABASE_DIRECTORY=/var/data/clamav'
    sources:
      - type: archive
        url: https://www.clamav.net/downloads/production/clamav-0.105.1.tar.gz
        sha256: d2bc16374db889a6e5a6ac40f8c6e700254a039acaa536885a09eeea4b8529f6
    post-install:
      - 'sed "s/^Example/#Example/" /app/etc/freshclam.conf.sample > /app/etc/freshclam.conf'
    cleanup:
      - '/bin/clamav-config'
      - '/include'
      - '/lib/pkgconfig'
      - '/sbin'
      - '/share/doc'
      - '*.conf.sample'

  - name: clamtk
    buildsystem: simple
    build-commands:
      - 'install -Dm 755 clamtk /app/bin/clamtk'
      - |
        sitelib=$(perl -e 'use Config; print $Config{installsitelib};')
        install -d $sitelib
        cp -r lib $sitelib/ClamTk
      - 'install -Dm 644 clamtk.desktop /app/share/applications/com.gitlab.davem.ClamTk.desktop'
      - 'install -Dm 644 images/clamtk.png /app/share/icons/hicolor/128x128/apps/clamtk.png'
      - 'install -Dm 644 com.gitlab.davem.ClamTk.metainfo.xml -t /app/share/metainfo'
    sources:
      - type: archive
        url: https://github.com/dave-theunsub/clamtk/releases/download/v6.13/clamtk-6.13.tar.xz
        sha256: 91bc42b761d32c4b72a0cdb341dfe06949179796d1f4b05a22090c0047d92d58
      - type: patch
        path: 0001-Remove-some-functionality-that-doesn-t-apply-to-Flat.patch
      - type: patch
        path: 0002-Various-Flatpak-specific-config-changes.patch
      - type: patch
        path: 0003-Some-more-icon-fixes.patch
      - type: patch
        path: 0004-Update-releases-in-appdata.patch
      - type: patch
        path: 0005-Flatpak-specific-appdata-changes.patch
